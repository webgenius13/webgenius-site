<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WRP — Gestion VPN (DB)</title>
  <style>
    :root{--bg:#0a1020;--panel:#121c35;--line:#2b3d66;--text:#eef3ff;--muted:#a8bbe3;--blue:#1d4ed8;--danger:#ef4444;--ok:#22c55e;--warn:#f59e0b}
    body{font-family:Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1050px;margin:24px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:12px}
    input,button,select{padding:9px;border-radius:8px;border:1px solid #334a79;background:#0f1730;color:var(--text)}
    button{cursor:pointer;background:var(--blue);font-weight:600}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .vpn{padding:11px;border:1px solid #314975;border-radius:10px;margin:8px 0}
    .muted{color:var(--muted)}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #3b568f}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}
    .head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .err{color:#fecaca;background:#7f1d1d33;border:1px solid #7f1d1d;border-radius:8px;padding:8px;margin-top:8px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1>WRP — Page web + base SQLite</h1>
      <small class="muted" id="health">API: vérification...</small>
    </div>

    <div class="card">
      <h3>Créer un VPN</h3>
      <div class="row">
        <input id="name" placeholder="Nom du fichier VPN" />
        <input id="creator" placeholder="Créateur" value="Admin" />
        <input id="ttl" type="number" min="1" max="1440" value="30" />
        <button id="createVpn">Ajouter</button>
      </div>
      <div class="err" id="vpnErr"></div>
    </div>

    <div class="card">
      <h3>VPN enregistrés</h3>
      <div id="vpns"></div>
    </div>

    <div class="card">
      <h3>Ajouter un commentaire</h3>
      <div class="row">
        <select id="vpnId"></select>
        <input id="author" placeholder="Auteur" value="Utilisateur" />
        <input id="content" placeholder="Commentaire (max 240)" style="min-width:260px" />
        <button id="addComment">Commenter</button>
      </div>
      <div class="err" id="commentErr"></div>
      <div id="comments" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const vpnsEl = $('vpns');
    const vpnIdEl = $('vpnId');

    function showErr(id, msg=''){
      const el = $(id);
      if(!msg){el.style.display='none';el.textContent='';return;}
      el.textContent = msg;
      el.style.display = 'block';
    }

    function remainMeta(iso){
      const diff = Math.floor((new Date(iso)-new Date())/1000);
      if(diff<=0) return {text:'Expiré', cls:'danger'};
      const h = String(Math.floor(diff/3600)).padStart(2,'0');
      const m = String(Math.floor((diff%3600)/60)).padStart(2,'0');
      const s = String(diff%60).padStart(2,'0');
      const cls = diff<=300?'danger':diff<=900?'warn':'ok';
      return {text:`${h}:${m}:${s}`, cls};
    }

    async function api(path, opts={}){
      const res = await fetch(path, opts);
      const data = await res.json().catch(()=>({error:'réponse invalide'}));
      if(!res.ok) throw new Error(data.error || 'erreur API');
      return data;
    }

    async function checkHealth(){
      try{ await api('/health'); $('health').textContent='API: en ligne'; }
      catch{ $('health').textContent='API: indisponible'; }
    }

    async function renderVpns(){
      showErr('vpnErr');
      const vpns = await api('/api/vpns');
      vpnsEl.innerHTML = vpns.map(v=>{
        const r = remainMeta(v.expires_at);
        return `<div class="vpn">
          <b>${v.name}</b> <span class="badge ${r.cls}">${r.cls==='ok'?'Actif':r.cls==='warn'?'Expire bientôt':'Critique/Expiré'}</span><br>
          <small class="muted">Créateur: ${v.creator}</small><br>
          <small class="muted">Temps restant: <span data-exp="${v.expires_at}" class="${r.cls}">${r.text}</span></small>
        </div>`;
      }).join('') || '<small class="muted">Aucun VPN</small>';

      vpnIdEl.innerHTML = vpns.map(v=>`<option value="${v.id}">#${v.id} - ${v.name}</option>`).join('');
      if(vpns.length) await loadComments(vpnIdEl.value);
      else $('comments').innerHTML = '<small class="muted">Pas de commentaire</small>';
    }

    async function loadComments(vpnId){
      showErr('commentErr');
      if(!vpnId){ $('comments').innerHTML=''; return; }
      const rows = await api(`/api/comments?vpn_id=${vpnId}`);
      $('comments').innerHTML = rows.map(c=>`<div class="vpn"><b>${c.author}</b> · <small class="muted">${c.created_at}</small><br>${c.content}</div>`).join('') || '<small class="muted">Pas de commentaire</small>';
    }

    $('createVpn').onclick = async () => {
      try{
        await api('/api/vpns', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            name:$('name').value.trim(),
            creator:$('creator').value.trim(),
            ttl_minutes:Number($('ttl').value||30)
          })
        });
        $('name').value='';
        await renderVpns();
      }catch(e){ showErr('vpnErr', e.message); }
    };

    $('addComment').onclick = async () => {
      try{
        await api('/api/comments', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            vpn_id:Number(vpnIdEl.value),
            author:$('author').value.trim(),
            content:$('content').value.trim()
          })
        });
        $('content').value='';
        await loadComments(vpnIdEl.value);
      }catch(e){ showErr('commentErr', e.message); }
    };

    vpnIdEl.onchange = () => loadComments(vpnIdEl.value);

    setInterval(() => {
      document.querySelectorAll('[data-exp]').forEach((el)=>{
        const r = remainMeta(el.getAttribute('data-exp'));
        el.textContent = r.text;
        el.classList.remove('ok','warn','danger');
        el.classList.add(r.cls);
      });
    }, 1000);

    checkHealth();
    renderVpns().catch(e=>showErr('vpnErr', e.message));
  </script>
</body>
</html>
